{% extends "base.html" %}
{% block content %}
  <h3 class="mb-3">{{ title }}</h3>

  <p class="text-secondary">
    Единый формат: <code>code, brand, fraction, ash, moist, sulfur, status</code>.
    Импорт CSV/XLSX и ручное добавление строк.
  </p>

  <!-- Импорт -->
  <form class="row g-2 align-items-center mb-3" method="post" enctype="multipart/form-data">
    <div class="col-12 col-md-6">
      <input class="form-control" type="file" name="file" accept=".csv,.xlsx">
    </div>
    <div class="col-auto">
      <button type="button" class="btn btn-primary">Импортировать</button>
    </div>
    <div class="col-auto">
      <a class="btn btn-outline-secondary" href="{{ url_for('product_metrics.template_xlsx') }}">Шаблон XLSX</a>
    </div>
  </form>

  <!-- Ручное добавление -->
  <details class="mb-3">
    <summary class="mb-2">Параметры / Ручное добавление</summary>
    <form class="row g-2 align-items-end" id="add-form" onsubmit="return false;">
      {% for c in columns %}
        <div class="col-6 col-md-3 col-lg-2">
          <label class="form-label small">{{ c.title }}</label>
          {% if c.enum %}
            <select class="form-select form-select-sm" name="{{ c.key }}">
              <option value="" selected>—</option>
              {% for v in c.enum %}<option>{{ v }}</option>{% endfor %}
            </select>
          {% else %}
            <input class="form-control form-control-sm" name="{{ c.key }}"
                   {% if c.type=='num' %}type="number" step="any"{% else %}type="text"{% endif %}>
          {% endif %}
        </div>
      {% endfor %}
      <div class="col-12 col-md-auto">
        <button class="btn btn-success btn-sm" id="btn-add">Добавить</button>
      </div>
    </form>
  </details>

  <!-- Таблица -->
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          {% for c in columns %}<th>{{ c.title }}</th>{% endfor %}
          <th class="text-end" style="width:64px">Действия</th>
        </tr>
      </thead>
      <tbody id="grid">
        <tr class="text-secondary"><td colspan="{{ columns|length + 1 }}">Данных пока нет. Импортируйте или добавьте вручную.</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Экспорт -->
  <div class="d-flex gap-2">
    <a class="btn btn-success btn-sm" href="{{ url_for('product_metrics.export_csv') }}">Экспорт CSV</a>
    <a class="btn btn-success btn-sm" href="{{ url_for('product_metrics.template_xlsx') }}">Экспорт XLSX</a>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('product_metrics.params') }}">Параметры (JSON)</a>
  </div>

  <script>
    const grid = document.getElementById('grid');
    const addBtn = document.getElementById('btn-add');
    const addForm = document.getElementById('add-form');

    function rowTemplate(){
      return `<tr>` +
        `{% for c in columns %}<td data-k="{{ c.key }}"></td>{% endfor %}` +
        `<td class="text-end"><button class="btn btn-outline-danger btn-sm js-del">Удалить</button></td>` +
        `</tr>`;
    }
    function fill(tr, rec){
      {% for c in columns %}
      tr.querySelector('[data-k="{{ c.key }}"]').textContent = rec['{{ c.key }}'] ?? '';
      {% endfor %}
    }

    addBtn.addEventListener('click', ()=>{
      const fd = new FormData(addForm); const rec={}; for (const [k,v] of fd.entries()) rec[k]=v;
      const tr = document.createElement('tr'); tr.innerHTML = rowTemplate(); grid.appendChild(tr); fill(tr, rec);
    });
    grid.addEventListener('click', (e)=>{ if (e.target.matches('.js-del')) e.target.closest('tr')?.remove(); });
  </script>
{% endblock %}
