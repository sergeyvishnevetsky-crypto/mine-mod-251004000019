{% extends "base.html" %}
{% block content %}
<h3 class="mb-3">{{ title }}</h3>

{# ======= –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ ======= #}
<div class="card mb-3">
  <div class="card-body d-flex flex-wrap align-items-end gap-3">
    <form class="d-flex flex-wrap gap-2 align-items-end" method="get" action="{{ url_for('workbook.index') }}">
      <div>
        <label class="form-label mb-1">–î–∞—Ç–∞</label>
        <input type="date" class="form-control" name="date" value="{{ flt.date }}">
      </div>
      <div>
        <label class="form-label mb-1">–£—á–∞—Å—Ç–æ–∫</label>
        <input class="form-control" name="site" value="{{ flt.site }}">
      </div>
      <div>
        <label class="form-label mb-1">–ë—Ä–∏–≥–∞–¥–∞</label>
        <input class="form-control" name="brigade" value="{{ flt.brigade }}">
      </div>
      <div>
        <label class="form-label mb-1">–°–º–µ–Ω–∞</label>
        <select class="form-select" name="shift">
          {% for s in shifts %}<option value="{{s}}" {{ 'selected' if flt.shift==s else '' }}>{{ s }}</option>{% endfor %}
        </select>
      </div>
      <button class="btn btn-outline-secondary">–ü–æ–∫–∞–∑–∞—Ç—å</button>
    </form>

    <div class="ms-auto d-flex flex-wrap gap-2">
      <span class="align-self-center">
        –°—Ç–∞—Ç—É—Å —Å–º–µ–Ω—ã:
        {% if shift.status == 'plan' %}
          <span class="badge bg-info text-dark">–ü–õ–ê–ù</span>
        {% elif shift.status == 'fact' %}
          <span class="badge bg-warning text-dark">–§–ê–ö–¢</span>
        {% else %}
          <span class="badge bg-secondary">–ó–ê–ö–†–´–¢–û</span>
        {% endif %}
      </span>

      {% if shift.status == 'plan' %}
        <form method="post" action="{{ url_for('workbook.lock_plan', **flt) }}">
          <button class="btn btn-primary">‚úî –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ü–õ–ê–ù (–ø–µ—Ä–µ–π—Ç–∏ –∫ –§–ê–ö–¢)</button>
        </form>
      {% elif shift.status == 'fact' %}
        <form method="post" action="{{ url_for('workbook.copy_plan_to_fact', **flt) }}">
          <button class="btn btn-outline-primary">‚ü≤ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω‚Üí—Ñ–∞–∫—Ç</button>
        </form>
        <form method="post" action="{{ url_for('workbook.close_shift', **flt) }}">
          <button class="btn btn-success">‚úÖ –ó–∞–∫—Ä—ã—Ç—å —Å–º–µ–Ω—É</button>
        </form>
      {% else %}
        <form method="post" action="{{ url_for('workbook.reopen_to_plan', **flt) }}">
          <button class="btn btn-outline-secondary">‚Ü© –í–µ—Ä–Ω—É—Ç—å –≤ –ü–õ–ê–ù</button>
        </form>
      {% endif %}

      <a class="btn btn-outline-primary" href="{{ url_for('workbook.template_plan', **flt) }}">üìÑ –®–∞–±–ª–æ–Ω –ø–ª–∞–Ω–∞</a>
      {% if shift.status == 'plan' %}
      <form method="post" action="{{ url_for('workbook.import_plan', **flt) }}" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
        <label class="form-label mb-0">–ò–º–ø–æ—Ä—Ç –ø–ª–∞–Ω–∞:</label>
        <input type="file" name="file" class="form-control" accept=".xlsx,.csv" required style="max-width:260px">
        <button class="btn btn-outline-success">‚¨Ü –ò–º–ø–æ—Ä—Ç</button>
      </form>
      {% endif %}
      <a class="btn btn-outline-primary" href="{{ url_for('workbook.export_csv', **flt) }}">‚¨á –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
    </div>
  </div>
</div>

{# ======= –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ ======= #}
<div class="card mb-3">
  <div class="card-body">
    {% if shift.status == 'closed' %}
      <div class="alert alert-secondary mb-0">–°–º–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.</div>
    {% else %}
    <form class="row g-2" method="post" action="{{ url_for('workbook.add_row', **flt) }}">
      <div class="col-md-3">
        <label class="form-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
        <select class="form-select" name="employee_id" required>
          {% for e in employees %}<option value="{{e.id}}">{{ e.tab_no }} ‚Äî {{ e.name }} ({{ e.role }})</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">–í–∏–¥ —Ä–∞–±–æ—Ç (–Ω–æ—Ä–º–∞)</label>
        <select class="form-select" name="norm_id" required>
          {% for n in norms %}<option value="{{n.id}}">{{ n.code }} ‚Äî {{ n.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">–ü–ª–∞–Ω, –∫–æ–ª-–≤–æ</label>
        <input type="number" step="0.001" class="form-control" name="qty_plan" value="0" {{ 'readonly' if shift.status=='fact' }}>
      </div>
      <div class="col-md-2">
        <label class="form-label">–§–∞–∫—Ç, –∫–æ–ª-–≤–æ</label>
        <input type="number" step="0.001" class="form-control" name="qty_fact" value="0" {{ 'readonly' if shift.status!='fact' }}>
      </div>
      <div class="col-md-12">
        <label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
        <input class="form-control" name="note">
      </div>
      <div class="col-12"><button class="btn btn-primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button></div>
    </form>
    {% endif %}
  </div>
</div>

{# ======= –¢–∞–±–ª–∏—Ü–∞ ======= #}
<div class="card">
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>–°–æ—Ç—Ä.</th><th>–î–æ–ª–∂–Ω.</th><th>–ö–æ–¥</th><th>–í–∏–¥ —Ä–∞–±–æ—Ç</th><th>–ï–¥.</th><th>–ù–æ—Ä–º–∞</th>
          <th>–ü–ª–∞–Ω, –∫–æ–ª-–≤–æ</th><th>–ü–ª–∞–Ω, —Å—É–º–º–∞</th><th>–§–∞–∫—Ç, –∫–æ–ª-–≤–æ</th><th>–§–∞–∫—Ç, —Å—É–º–º–∞</th><th>–û—Ç–∫–ª–æ–Ω.</th><th>–ü—Ä–∏–º.</th><th></th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        {% set e = (employees | selectattr('id','equalto',r.employee_id) | list | first) %}
        {% set n = (norms | selectattr('id','equalto',r.norm_id) | list | first) %}
        {% set dev = (r.qty_fact|float) - (r.qty_plan|float) %}
        <tr>
          <td>{{ e.name }}</td>
          <td>{{ e.role }}</td>
          <td>{{ n.code }}</td>
          <td>{{ n.name }}</td>
          <td>{{ r.unit }}</td>
          <td>{{ '%.3f'|format(r.norm|float) }}</td>
          <td>{{ '%.3f'|format(r.qty_plan|float) }}</td>
          <td>{{ '%.2f'|format(r.sum_plan|float) }}</td>
          <td>{{ '%.3f'|format(r.qty_fact|float) }}</td>
          <td>{{ '%.2f'|format(r.sum_fact|float) }}</td>
          <td class="{{ 'text-success' if dev>=0 else 'text-danger' }}">{{ '%+.3f'|format(dev) }}</td>
          <td>{{ r.note }}</td>
          <td class="text-nowrap">
            {% if shift.status != 'closed' %}
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('workbook.edit', rid=r.id, **flt) }}">–†–µ–¥–∞–∫—Ç.</a>
              <a class="btn btn-sm btn-outline-danger" href="{{ url_for('workbook.delete', rid=r.id, **flt) }}">–£–¥–∞–ª–∏—Ç—å</a>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
        {% if rows|length == 0 %}
        <tr><td colspan="13" class="text-center text-secondary py-4">–ù–µ—Ç —Å—Ç—Ä–æ–∫</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <div class="card-body d-flex justify-content-between">
    <div class="h6 mb-0">–ò–¢–û–ì–û –ø–æ —Å–º–µ–Ω–µ ({{ flt.date }} ‚Ä¢ {{ flt.shift }}):</div>
    <div class="text-end">
      <div>–ü–ª–∞–Ω: <b>{{ '%.3f'|format(plan_qty) }}</b> ‚Ä¢ <b>{{ '%.2f'|format(plan_sum) }}</b> –≥—Ä–Ω</div>
      <div>–§–∞–∫—Ç: <b>{{ '%.3f'|format(fact_qty) }}</b> ‚Ä¢ <b>{{ '%.2f'|format(fact_sum) }}</b> –≥—Ä–Ω</div>
    </div>
  </div>
</div>

{# ======= –ò—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–º–µ–Ω—ã) ======= #}
<div class="card mt-3">
  <div class="card-header">–ò—Å—Ç–æ—Ä–∏—è (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–º–µ–Ω)</div>
  <div class="table-responsive">
    <table class="table table-sm mb-0">
      <thead class="table-light">
        <tr><th>–î–∞—Ç–∞</th><th>–°–º–µ–Ω–∞</th><th>–£—á–∞—Å—Ç–æ–∫</th><th>–ë—Ä–∏–≥–∞–¥–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th class="text-end">–ü–ª–∞–Ω, –µ–¥.</th><th class="text-end">–ü–ª–∞–Ω, –≥—Ä–Ω</th><th class="text-end">–§–∞–∫—Ç, –µ–¥.</th><th class="text-end">–§–∞–∫—Ç, –≥—Ä–Ω</th></tr>
      </thead>
      <tbody>
        {% for h in history %}
        <tr>
          <td><a href="{{ url_for('workbook.index', date=h.date, shift=h.shift, site=h.site, brigade=h.brigade) }}">{{ h.date }}</a></td>
          <td>{{ h.shift }}</td>
          <td>{{ h.site }}</td>
          <td>{{ h.brigade }}</td>
          <td>
            {% if h.status == 'plan' %}<span class="badge bg-info text-dark">–ü–õ–ê–ù</span>
            {% elif h.status == 'fact' %}<span class="badge bg-warning text-dark">–§–ê–ö–¢</span>
            {% else %}<span class="badge bg-secondary">–ó–ê–ö–†–´–¢–û</span>{% endif %}
          </td>
          <td class="text-end">{{ '%.3f'|format(h.plan_qty|float) }}</td>
          <td class="text-end">{{ '%.2f'|format(h.plan_sum|float) }}</td>
          <td class="text-end">{{ '%.3f'|format(h.fact_qty|float) }}</td>
          <td class="text-end">{{ '%.2f'|format(h.fact_sum|float) }}</td>
        </tr>
        {% endfor %}
        {% if history|length == 0 %}<tr><td colspan="9" class="text-center text-secondary py-3">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</td></tr>{% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
