{% extends "base.html" %}{% block content %}
<h3 class="mb-3">{{ title }}</h3>

<div class="card mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-3"><label class="form-label">с даты</label><input type="date" class="form-control" name="from" value="{{ request.args.get('from','') }}"></div>
      <div class="col-md-3"><label class="form-label">по дату</label><input type="date" class="form-control" name="to" value="{{ request.args.get('to','') }}"></div>
      <div class="col-md-3"><label class="form-label">Фракция</label><input class="form-control" name="fraction" value="{{ request.args.get('fraction','') }}"></div>
      <div class="col-md-3 d-flex gap-2 mt-4">
        <button class="btn btn-outline-secondary">Фильтр</button>
        <a class="btn btn-outline-dark" href="{{ url_for('mining_report.index') }}">Сброс</a>
        <a class="btn btn-primary ms-auto" href="{{ url_for('mining_report.new') }}">➕ Добавить запись</a>
        <a class="btn btn-outline-primary" href="{{ url_for('mining_report.export_csv') }}">⬇ Экспорт CSV</a>
        <form method="post" action="{{ url_for('mining_report.import_') }}" enctype="multipart/form-data" class="d-inline-flex gap-2">
          <input type="file" name="file" class="form-control" accept=".xlsx,.csv" required style="max-width:240px">
          <button class="btn btn-outline-success">⬆ Импорт</button>
        </form>
      </div>
    </form>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-4"><div class="card"><div class="card-body">
    <div class="text-secondary">План за период</div>
    <div class="h4 mb-0">{{ '%.0f'|format(plan_sum) }} {{ rows[0].unit if rows|length>0 else 'т' }}</div>
  </div></div></div>
  <div class="col-md-4"><div class="card"><div class="card-body">
    <div class="text-secondary">Факт за период</div>
    <div class="h4 mb-0">{{ '%.0f'|format(fact_sum) }} {{ rows[0].unit if rows|length>0 else 'т' }}</div>
  </div></div></div>
  <div class="col-md-4"><div class="card"><div class="card-body">
    <div class="text-secondary">Отклонение</div>
    {% set d = fact_sum - plan_sum %}
    <div class="h4 mb-0">{{ '%+.0f'|format(d) }}</div>
  </div></div></div>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Дата</th><th>Фракция</th><th>Качество</th>
          <th class="text-end">План/сутки</th>
          <th class="text-end">Факт I</th>
          <th class="text-end">Факт II</th>
          <th class="text-end">Факт III</th>
          <th class="text-end">Факт IV</th>
          <th class="text-end">Факт/сутки</th>
          <th class="text-end">Откл.</th>
          <th>Прим.</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        {% set diff = (r.fact_total|float) - (r.plan_total|float) %}
        <tr>
          <td>{{ r.date }}</td>
          <td>{{ r.fraction }}</td>
          <td>{{ r.quality }}</td>
          <td class="text-end">{{ '%.3f'|format(r.plan_total|float) }}</td>
          <td class="text-end">{{ '%.3f'|format(r.fact_s1|float) }}</td>
          <td class="text-end">{{ '%.3f'|format(r.fact_s2|float) }}</td>
          <td class="text-end">{{ '%.3f'|format(r.fact_s3|float) }}</td>
          <td class="text-end">{{ '%.3f'|format(r.fact_s4|float) }}</td>
          <td class="text-end">{{ '%.3f'|format(r.fact_total|float) }}</td>
          <td class="text-end {% if diff>=0 %}text-success{% else %}text-danger{% endif %}">{{ '%+.3f'|format(diff) }}</td>
          <td>{{ r.note }}</td>
        </tr>
        {% endfor %}
        {% if rows|length == 0 %}
          <tr><td colspan="11" class="text-center text-secondary py-4">Нет данных</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
