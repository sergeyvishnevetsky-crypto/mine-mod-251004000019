{% extends "base.html" %}
{% block content %}
<h3 class="mb-3">{{ title }}</h3>

<div class="card mb-3">
  <div class="card-body d-flex flex-wrap align-items-end gap-3">
    <form class="d-flex flex-wrap gap-2 align-items-end" method="get" action="{{ url_for('workbook.index') }}">
      <div>
        <label class="form-label mb-1">–î–∞—Ç–∞</label>
        <input type="date" class="form-control" name="date" value="{{ flt.date }}">
      </div>
      <div>
        <label class="form-label mb-1">–£—á–∞—Å—Ç–æ–∫</label>
        <input class="form-control" name="site" value="{{ flt.site }}">
      </div>
      <div>
        <label class="form-label mb-1">–ë—Ä–∏–≥–∞–¥–∞</label>
        <input class="form-control" name="brigade" value="{{ flt.brigade }}">
      </div>
      <div>
        <label class="form-label mb-1">–°–º–µ–Ω–∞</label>
        <select class="form-select" name="shift">
          {% for s in shifts %}<option value="{{s}}" {{ 'selected' if flt.shift==s else '' }}>{{ s }}</option>{% endfor %}
        </select>
      </div>
      <button class="btn btn-outline-secondary">–ü–æ–∫–∞–∑–∞—Ç—å</button>
    </form>

    <div class="ms-auto d-flex flex-wrap gap-2">
      <form method="post" action="{{ url_for('workbook.copy_plan_to_fact', **flt) }}">
        <button class="btn btn-outline-primary">‚ü≤ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω‚Üí—Ñ–∞–∫—Ç</button>
      </form>

      <a class="btn btn-outline-primary" href="{{ url_for('workbook.template_plan', **flt) }}">üìÑ –®–∞–±–ª–æ–Ω –ø–ª–∞–Ω–∞ (XLSX/CSV)</a>
      <form method="post" action="{{ url_for('workbook.import_plan', **flt) }}" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
        <label class="form-label mb-0">–ò–º–ø–æ—Ä—Ç –ø–ª–∞–Ω–∞:</label>
        <input type="file" name="file" class="form-control" accept=".xlsx,.csv" required style="max-width:260px">
        <button class="btn btn-outline-success">‚¨Ü –ò–º–ø–æ—Ä—Ç</button>
      </form>
      <a class="btn btn-outline-primary" href="{{ url_for('workbook.export_csv', **flt) }}">‚¨á –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <form class="row g-2" method="post" action="{{ url_for('workbook.add_row', **flt) }}">
      <div class="col-md-3">
        <label class="form-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
        <select class="form-select" name="employee_id" required>
          {% for e in employees %}<option value="{{e.id}}">{{ e.tab_no }} ‚Äî {{ e.name }} ({{ e.role }})</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">–í–∏–¥ —Ä–∞–±–æ—Ç (–Ω–æ—Ä–º–∞)</label>
        <select class="form-select" name="norm_id" required>
          {% for n in norms %}<option value="{{n.id}}">{{ n.code }} ‚Äî {{ n.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-2"><label class="form-label">–ü–ª–∞–Ω, –∫–æ–ª-–≤–æ</label><input type="number" step="0.001" class="form-control" name="qty_plan" value="0"></div>
      <div class="col-md-2"><label class="form-label">–§–∞–∫—Ç, –∫–æ–ª-–≤–æ</label><input type="number" step="0.001" class="form-control" name="qty_fact" value="0"></div>
      <div class="col-md-2"><label class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label><input class="form-control" name="note"></div>
      <div class="col-12"><button class="btn btn-primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button></div>
    </form>
  </div>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>–°–æ—Ç—Ä.</th><th>–î–æ–ª–∂–Ω.</th><th>–ö–æ–¥</th><th>–í–∏–¥ —Ä–∞–±–æ—Ç</th><th>–ï–¥.</th><th>–ù–æ—Ä–º–∞</th>
          <th>–ü–ª–∞–Ω, –∫–æ–ª-–≤–æ</th><th>–ü–ª–∞–Ω, —Å—É–º–º–∞</th><th>–§–∞–∫—Ç, –∫–æ–ª-–≤–æ</th><th>–§–∞–∫—Ç, —Å—É–º–º–∞</th><th>–û—Ç–∫–ª–æ–Ω.</th><th>–ü—Ä–∏–º.</th><th></th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        {% set e = (employees | selectattr('id','equalto',r.employee_id) | list | first) %}
        {% set n = (norms | selectattr('id','equalto',r.norm_id) | list | first) %}
        <tr>
          <td>{{ e.name }}</td>
          <td>{{ e.role }}</td>
          <td>{{ n.code }}</td>
          <td>{{ n.name }}</td>
          <td>{{ r.unit }}</td>
          <td>{{ '%.3f'|format(r.norm|float) }}</td>
          <td>{{ '%.3f'|format(r.qty_plan|float) }}</td>
          <td>{{ '%.2f'|format(r.sum_plan|float) }}</td>
          <td>{{ '%.3f'|format(r.qty_fact|float) }}</td>
          <td>{{ '%.2f'|format(r.sum_fact|float) }}</td>
          {% set dev = (r.qty_fact|float) - (r.qty_plan|float) %}
          <td class="{{ 'text-success' if dev>=0 else 'text-danger' }}">{{ '%+.3f'|format(dev) }}</td>
          <td>{{ r.note }}</td>
          <td class="text-nowrap">
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('workbook.edit', rid=r.id, **flt) }}">–†–µ–¥–∞–∫—Ç.</a>
            <a class="btn btn-sm btn-outline-danger" href="{{ url_for('workbook.delete', rid=r.id, **flt) }}">–£–¥–∞–ª–∏—Ç—å</a>
          </td>
        </tr>
        {% endfor %}
        {% if rows|length == 0 %}
        <tr><td colspan="13" class="text-center text-secondary py-4">–ù–µ—Ç —Å—Ç—Ä–æ–∫</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>

  <div class="card-body d-flex justify-content-between">
    <div class="h6 mb-0">–ò–¢–û–ì–û –ø–æ —Å–º–µ–Ω–µ:</div>
    <div class="text-end">
      <div>–ü–ª–∞–Ω: <b>{{ '%.3f'|format(plan_qty) }}</b> ‚Ä¢ <b>{{ '%.2f'|format(plan_sum) }}</b> –≥—Ä–Ω</div>
      <div>–§–∞–∫—Ç: <b>{{ '%.3f'|format(fact_qty) }}</b> ‚Ä¢ <b>{{ '%.2f'|format(fact_sum) }}</b> –≥—Ä–Ω</div>
    </div>
  </div>
</div>
{% endblock %}
