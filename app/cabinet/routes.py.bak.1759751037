from flask import Blueprint, render_template, request, abort, redirect, url_for, flash

cabinet_bp = Blueprint("cabinet", __name__, template_folder="templates")

# ===== СПРАВОЧНИКИ (вкладка refs) =====
REFS = {
    "1": ("Нормы и расценки",        "pickers/norms.html"),
    "2": ("Перечень ТМЦ",             "pickers/tmc.html"),
    "3": ("Перечень услуг",           "pickers/services.html"),
    "4": ("Статьи доходов и расходов", "pickers/revexp_items.html"),
}


# Движение продукции — отдельная вкладка
MOV = {
    'mov1': ('Движение продукции', 'pickers/movement.html'),
}
# ===== РАБОЧИЕ ДОКУМЕНТЫ (вкладка docs) =====
DOCS = {
    "90": ("Отчёт о переработке",        "pickers/proc.html"),
    "91": ("Склад готовой продукции",     "pickers/fgwh.html"),

    "1": ("Книга нарядов",               "pickers/workbook.html"),
    "2": ("Заявка на ТМЦ",               "pickers/req_tmc.html"),
    "3": ("Заявка на оказание услуг",    "pickers/req_services.html"),
    "4": ("Табель выходов",              "pickers/generic.html"),
    "5": ("Отчет о добыче",              "pickers/report_mining.html"),
    "6": ("Отчет об отгрузке",           "pickers/generic.html"),
    "7": ("Баланс ТМЦ",                  "pickers/generic.html"),
    "8": ("Баланс товара",               "pickers/generic.html"),
    "9": ("Отчет об оказанных услугах",  "pickers/generic.html"),
}

def _items_for(tab:str):
    return REFS if tab == "refs" else DOCS

@cabinet_bp.get("/")
# Карта вкладок Кабинета
TAB_MAP = {
    'docs': DOCS,
    'refs': REFS,
    'moves': MOV,
}

def index():
    from flask import request, render_template
    tab = request.args.get('tab', 'docs')
    items_map = TAB_MAP.get(tab, DOCS)
    # Преобразуем в список удобных структур
    items = [{'key': k, 'label': v[0], 'tpl': v[1]} for k, v in sorted(items_map.items())]
    title = "Кабинет участка"
    return render_template("cabinet.html", title=title, tab=tab, items=items)
    tab = request.args.get("tab", "docs")  # 'docs' или 'refs'
    ITEMS = _items_for(tab)
    items = TAB_MAP.get(tab, DOCS)
    return render_template("cabinet.html", title="Кабинет участка", tab=tab, items=items)

@cabinet_bp.get("/picker/<key>")
def picker(key):
    from flask import request, render_template, abort
    # tab нам нужен только для возврата в ту же вкладку
    tab = request.args.get('tab', 'docs')
    rec = ALL_MAP.get(key)
    if not rec:
        abort(404)
    label, tpl = rec
    return render_template(tpl, key=key, tab=tab, label=label)
    tab = request.args.get("tab", "docs")
    ITEMS = _items_for(tab)
    info = ITEMS.get(key)
    if not info:
        abort(404)
    label, tpl = info
    # передаём текущую вкладку, чтобы после submit вернуться туда же
    return render_template(tpl, key=key, label=label, tab=tab)

@cabinet_bp.post("/run/<key>")
def run_action(key: str):
    tab = request.args.get("tab", "docs")
    ITEMS = _items_for(tab)
    if key not in ITEMS:
        abort(404)
    # пример чтения параметров формы
    period = request.form.get("period", "")
    site = request.form.get("site", "")
    shift = request.form.get("shift", "")
    flash(f"[{ 'Справочники' if tab=='refs' else 'Рабочие документы' }] {ITEMS[key][0]} → период={period}, участок={site}, смена={shift}", "ok")
    return redirect(url_for("cabinet.index", tab=tab))
